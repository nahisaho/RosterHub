version: '3.8'

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: rosterhub-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-rosterhub}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rosterhub_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-rosterhub_dev}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - rosterhub-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-rosterhub}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Redis (for BullMQ)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: rosterhub-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-rosterhub_redis} --appendonly yes --maxmemory-policy noeviction
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - rosterhub-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ============================================
  # NestJS API Application
  # ============================================
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
      target: production
      args:
        - BUILDKIT_INLINE_CACHE=1
    dns:
      - 1.1.1.1
      - 8.8.8.8
    container_name: rosterhub-api
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${API_PORT:-3000}

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-rosterhub}:${POSTGRES_PASSWORD:-rosterhub_dev_password}@postgres:5432/${POSTGRES_DB:-rosterhub_dev}?schema=public

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-rosterhub_redis}

      # JWT
      JWT_SECRET: ${JWT_SECRET:-change_me_in_production}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-1h}

      # API Security
      API_KEY_ENABLED: ${API_KEY_ENABLED:-true}
      IP_WHITELIST_ENABLED: ${IP_WHITELIST_ENABLED:-false}
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL:-60}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}

      # Audit Logging
      AUDIT_LOG_ENABLED: ${AUDIT_LOG_ENABLED:-true}

      # CSV Processing
      CSV_UPLOAD_MAX_SIZE: ${CSV_UPLOAD_MAX_SIZE:-52428800}
      CSV_BATCH_SIZE: ${CSV_BATCH_SIZE:-1000}

      # OneRoster
      ONEROSTER_VERSION: ${ONEROSTER_VERSION:-1.2}
      JAPAN_PROFILE_VERSION: ${JAPAN_PROFILE_VERSION:-1.2.2}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${API_PORT:-3000}:3000"
    volumes:
      - ./apps/api/uploads:/app/uploads
      - ./apps/api/logs:/app/logs
    networks:
      - rosterhub-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # ============================================
  # Nginx Reverse Proxy (Optional - Production)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: rosterhub-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    networks:
      - rosterhub-network
    profiles:
      - production

  # ============================================
  # Adminer (Database Management - Development Only)
  # ============================================
  adminer:
    image: adminer:latest
    container_name: rosterhub-adminer
    restart: unless-stopped
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres
    networks:
      - rosterhub-network
    profiles:
      - development

# ============================================
# Networks
# ============================================
networks:
  rosterhub-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
